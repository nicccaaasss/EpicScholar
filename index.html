<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EpicScholar | Login</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #000; color: white; height: 100vh; display: flex; justify-content: space-between; align-items: center; padding: 0 5%; }
    .left { flex: 1; display: flex; justify-content: center; align-items: center; }
    .left h1 { font-size: 5rem; font-weight: 700; background: linear-gradient(90deg, #ff416c, #0072ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradientFlow 5s ease infinite; background-size: 200% 200%; }
    @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .right { flex: 1; display: flex; justify-content: center; align-items: center; }
    .box { background: black; backdrop-filter: blur(12px); padding: 30px 35px; border-radius: 20px; width: 340px; text-align: center; transition: all 0.5s ease; }
    .box h2 { margin-bottom: 20px; font-size: 24px; }
    .input-box { text-align: left; margin-bottom: 3.1px; background-color: transparent; }
    .input-box label { font-size: 14px; color: #ccc; }
    .input-box input, .input-box select { width: 100%; padding: 10px; border: solid 1px white; border-radius: 10px; margin-top: 5px; outline: none; background-color: transparent; color: white; }
    .message { font-size: 13px; margin-top: 5px; color: red; min-height: 16px; }
    .success { color: #4ade80; }
    .btn { width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 10px; background: linear-gradient(45deg, #ff416c, #0072ff); color: white; cursor: pointer; font-size: 16px; transition: 0.3s; }
    .btn:hover { transform: scale(1.05); }
    .switch { margin-top: 15px; font-size: 13px; }
    .switch a { color: #66aaff; text-decoration: none; cursor: pointer; }
    .switch a:hover { text-decoration: underline; }
    .status { font-size: 13px; margin-top: 10px; color: #4ade80; min-height: 18px; }
    .countdown { color: #ffcc00; margin-top: 5px; }
    .resend-btn { background: none; border: none; color: #66aaff; cursor: pointer; font-size: 13px; margin-top: 5px; }
     input:-webkit-autofill,
  input:-webkit-autofill:hover,
  input:-webkit-autofill:focus,
  input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0px 1000px black inset !important;
    -webkit-text-fill-color: white !important;
    background-color: transparent !important;
    background-clip: content-box !important;
  }
  </style>
</head>
<body>
  <div class="left">
    <h1>EpicScholar</h1>
  </div>

  <div class="right">
    <!-- LOGIN -->
    <div class="box" id="loginBox">
      <h2>Welcome to EpicScholar</h2>
      <div class="input-box">
        <label>Full Name</label>
        <input type="text" id="loginName" placeholder="Enter your full name" />
        <div id="loginNameMsg" class="message"></div>
      </div>
      <div class="input-box">
        <label>Password</label>
        <input type="password" id="loginPass" placeholder="Enter password" />
        <div id="loginPassMsg" class="message"></div>
      </div>
      <button class="btn" id="loginBtn">Sign In</button>
      <div id="loginStatus" class="status"></div>
      <div class="switch">
        New here? <a id="toSignup" href="#">Create account</a>
      </div>
    </div>

    <!-- SIGNUP -->
    <div class="box" id="signupBox" style="display:none;">
      <h2>Sign Up</h2>
      <div class="input-box">
        <label>Full Name</label>
        <input type="text" id="name" placeholder="Enter your name" />
        <div id="nameMsg" class="message"></div>
      </div>
      <div class="input-box">
        <label>Gmail ID</label>
        <input type="email" id="email" placeholder="Enter your Gmail ID" />
        <div id="emailMsg" class="message"></div>
      </div>
      <div class="input-box">
        <label>Password</label>
        <input type="password" id="password" placeholder="Create password" />
        <div id="passwordMsg" class="message"></div>
      </div>
      <div class="input-box">
        <label>Date of Birth</label>
        <input type="date" id="dob" />
        <div id="dobMsg" class="message"></div>
      </div>
      <div class="input-box">
        <label>Grade</label>
        <input type="number" id="grade" min="1" max="12" placeholder="Enter grade" />
        <div id="gradeMsg" class="message"></div>
      </div>
      <div class="input-box">
        <label>Syllabus</label>
        <select id="syllabus">
          <option value="">Select syllabus</option>
          <option value="CBSE">CBSE</option>
          <option value="ICSE">ICSE</option>
          <option value="Matriculation">Matriculation</option>
        </select>
        <div id="syllabusMsg" class="message"></div>
      </div>
      <button class="btn" id="signupBtn">Create Account</button>
      <div id="signupStatus" class="status"></div>
      <div id="countdown" class="countdown"></div>
      <button id="resendEmail" class="resend-btn" style="display:none;">Resend Email</button>
      <div class="switch">
        Already have an account? <a id="toLogin" href="#">Sign In</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://bipgnekdneqimjopldqo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpcGduZWtkbmVxaW1qb3BsZHFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODExNTQsImV4cCI6MjA3Njk1NzE1NH0.KN5x779xsaJD6Aw9W6Q9I_E4DvlM7bAG7LilsW0GGtU"; // replace with your anon key
    
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Toggle screens
    document.getElementById("toSignup").addEventListener("click", e => {
      e.preventDefault();
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("signupBox").style.display = "block";
      clearMessages();
    });
    document.getElementById("toLogin").addEventListener("click", e => {
      e.preventDefault();
      document.getElementById("signupBox").style.display = "none";
      document.getElementById("loginBox").style.display = "block";
      clearMessages();
    });

    function clearMessages() {
      document.querySelectorAll(".message, .status, .countdown").forEach(el => el.textContent = "");
    }

    // SIGNUP LOGIC
    const signupBtn = document.getElementById("signupBtn");
    const signupStatus = document.getElementById("signupStatus");
    const countdownEl = document.getElementById("countdown");
    const resendBtn = document.getElementById("resendEmail");
    let timer;

    signupBtn.addEventListener("click", async () => {
      clearMessages();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const dob = document.getElementById("dob").value;
      const grade = document.getElementById("grade").value;
      const syllabus = document.getElementById("syllabus").value;

      if (!name || !email || !password || !dob || !grade || !syllabus) {
        signupStatus.textContent = "All fields are required.";
        signupStatus.style.color = "red";
        return;
      }
        let valid = true;  // Add this at the top

const year = new Date(dob).getFullYear();
if (!isNaN(year) && (year < 1900 || year > new Date().getFullYear())) {
  document.getElementById("dobMsg").textContent = "Enter a valid year.";
  valid = false;
}

if (!valid) return;


  if (!valid) return;
      if (!email.endsWith("@gmail.com")) {
        signupStatus.textContent = "Please use a valid Gmail address.";
        signupStatus.style.color = "red";
        return;
      }

      signupStatus.textContent = "Sending verification email...";
      signupStatus.style.color = "#ffcc00";

      // Supabase Auth signup
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: window.location.origin + "/home.html" }
      });

      if (error) {
        signupStatus.textContent = `Error: ${error.message}`;
        signupStatus.style.color = "red";
        return;
      }

      // Insert into 'users' table
      const { error: tableError } = await supabase.from("users").insert([{
        id: data.user.id,
        full_name: name,
        gmail: email,
        dob,
        grade,
        syllabus
      }]);

      if (tableError) {
        signupStatus.textContent = `Error saving user data: ${tableError.message}`;
        signupStatus.style.color = "red";
        return;
      }
        localStorage.setItem("loggedInUser", JSON.stringify({
  id: data.user.id,
  full_name: name,
  gmail: email
}));
      signupStatus.textContent = "✅ Verification email sent! Please verify your Gmail.";
      signupStatus.style.color = "#4ade80";
      startCountdown(30);
    });

    function startCountdown(seconds) {
      let remaining = seconds;
      resendBtn.style.display = "none";
      countdownEl.textContent = `⏳ ${remaining}s remaining to verify.`;
      timer = setInterval(() => {
        remaining--;
        countdownEl.textContent = `⏳ ${remaining}s remaining to verify.`;
        if (remaining <= 0) {
          clearInterval(timer);
          countdownEl.textContent = "Didn't receive the email?";
          resendBtn.style.display = "block";
        }
      }, 1000);
    }

    resendBtn.addEventListener("click", () => {
      clearInterval(timer);
      document.getElementById("signupBtn").click();
      resendBtn.style.display = "none";
    });

    // LOGIN LOGIC
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");

    loginBtn.addEventListener("click", async () => {
      clearMessages();
      const fullName = document.getElementById("loginName").value.trim();
      const password = document.getElementById("loginPass").value.trim();

      if (!fullName || !password) {
        loginStatus.textContent = "Full Name and password are required.";
        loginStatus.style.color = "red";
        return;
      }

      loginStatus.textContent = "Signing in...";
      loginStatus.style.color = "#ffcc00";

      // Lookup Gmail by full name
      const { data: userData, error: lookupError } = await supabase
        .from("users")
        .select("gmail")
        .eq("full_name", fullName)
        .single();

      if (lookupError || !userData) {
        loginStatus.textContent = "User not found.";
        loginStatus.style.color = "red";
        return;
      }

      // Sign in via Supabase Auth using Gmail
      const { data, error } = await supabase.auth.signInWithPassword({
        email: userData.gmail,
        password
      });

      if (error) {
        loginStatus.textContent = `Error: ${error.message}`;
        loginStatus.style.color = "red";
        return;
      }

      loginStatus.textContent = "✅ Login successful!";
      loginStatus.style.color = "#4ade80";

     localStorage.setItem("loggedInUser", JSON.stringify({
  id: data.user.id,
  full_name: fullName,
  gmail: userData.gmail
}));

setTimeout(() => window.location.href = "home.html", 1000);
    });
  </script>
</body>
</html>
