<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EpicScholar</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <canvas id="bg"></canvas>
  
  <div id="feedback-message"></div>

  <div class="modal-overlay" id="commentModal">
    <div class="modal-content">
      <div class="title-small">Comments</div>
      <div class="modal-scroll" id="commentModalList"></div>
      <div class="comment-box">
        <textarea id="commentModalTextarea" placeholder="Write a comment..."></textarea>
        <button class="btn" id="commentModalPostBtn">Post</button>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="left side-col" id="leftCol">
      <div class="mini-card" id="reminderCard">
        <div class="mini-view"><div class="icon">‚è∞</div><div class="title">Reminders</div></div>
        <div class="panel-full"><div class="title-small">Reminders</div><div style="flex:1;overflow:auto"><ul id="remindersList"></ul></div><button class="btn" id="closeReminder">Close</button></div>
      </div>
      <div class="mini-card" id="scheduleCard">
        <div class="mini-view"><div class="icon">üìÖ</div><div class="title">Schedules</div></div>
        <div class="panel-full"><div class="title-small">Schedules</div><div style="flex:1;overflow:auto"><ul id="schedulesList"></ul></div><button class="btn" id="closeSchedule">Close</button></div>
      </div>
      <div class="mini-card" id="addEpicCard">
        <div class="mini-view"><div class="icon">‚ûï</div><div class="title">Add Content</div></div>
        <div class="panel-full"><div class="title-small">Create Post</div><div class="upload-area">
            <label class="file-choose" for="epicFileInput">üìÅ <span id="fileChooseLabel">Select file</span></label>
            <input id="epicFileInput" type="file" accept="image/*,video/*" style="position:absolute;left:-9999px" />
            
            <textarea id="epicCaption" class="caption-area" placeholder="Caption..."></textarea>
            <div class="preview-box" id="epicPreview">No preview</div>
            <div class="controls"><button class="btn" id="cancelUpload">Cancel</button><button class="btn" id="confirmUpload">Upload</button></div>
        </div></div>
      </div>
    </div>

    <div class="center">
      <div style="width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div class="title-small" style="flex-shrink:0;">EpicContent</div>
        <input type="search" id="searchBar" placeholder="Search posts by caption or author...">
        <div id="searchDropdown" class="search-dropdown"></div>
        <div style="display:flex;gap:8px;align-items:center"><div class="btn" id="refreshBtn">Refresh</div></div>
      </div>
      <div class="feed-viewport" id="feed"></div>
    </div>

    <div class="right side-col" id="rightCol">
      <div class="mini-card" id="notifsCard">
        <div class="mini-view"><div class="icon">üîî</div><div class="title">Notifications</div></div>
        <div class="panel-full"><div class="title-small">Notifications</div><div style="flex:1;overflow:auto"><ul id="notifList"></ul></div><button class="btn" id="closeNotifs">Close</button></div>
      </div>
      <div class="mini-card" id="devicesCard">
        <div class="mini-view"><div class="icon">üíª</div><div class="title">Devices</div></div>
        <div class="panel-full"><div class="title-small">Devices</div><div style="flex:1;overflow:auto"><ul id="devicesList"></ul></div><button class="btn" id="closeDevices">Close</button></div>
      </div>
      <div class="mini-card" id="testsCard">
        <div class="mini-view"><div class="icon">üß™</div><div class="title">Tests</div></div>
        <div class="panel-full"><div class="title-small">Tests</div><div style="flex:1;overflow:auto"><ul id="testsList"></ul></div><button class="btn" id="closeTests">Close</button></div>
      </div>
    </div>

    <div class="nav-bar">
      <div class="nav-wrap" id="navWrap">
        <div class="nav-item active" data-name="home">üè† <span class="label">Home</span></div>
        <div class="nav-item" data-name="messages">‚úâÔ∏è <span class="label">Messages</span></div>
        <div class="nav-item" data-name="self-study">üìö <span class="label">Self-Study</span></div>
        <div class="nav-item" data-name="edubot">ü§ñ <span class="label">EduBot</span></div>
        <div class="nav-item" data-name="profile"><div class="profile">SS</div> <span class="label">Profile</span></div>
        <div class="nav-underline" id="navUnderline"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
  
  <script>
     // Update the intro animation timeou
    /* ---------- Three.js background (FIXED) ---------- */
    const canvas=document.getElementById('bg');
    const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.setSize(window.innerWidth,window.innerHeight);
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,30000);
    camera.position.set(0,0,600);
    const ambient=new THREE.AmbientLight(0xffffff,0.3);
    const pointLight=new THREE.PointLight(0xffffff,0.6);
    pointLight.position.set(0,400,600);
    scene.add(ambient,pointLight);
    const bgStarsGeometry=new THREE.BufferGeometry();
    const bgStarsCount=8000;
    const bgPositions=new Float32Array(bgStarsCount*3);
    for(let i=0;i<bgStarsCount;i++){bgPositions[i*3]=(Math.random()-0.5)*20000;bgPositions[i*3+1]=(Math.random()-0.5)*10000;bgPositions[i*3+2]=-Math.random()*20000}
    bgStarsGeometry.setAttribute('position',new THREE.BufferAttribute(bgPositions,3));
    const bgStarsMaterial=new THREE.PointsMaterial({color:0xffffff,size:1.0,transparent:true,opacity:0.4,blending:THREE.AdditiveBlending});
    const bgStars=new THREE.Points(bgStarsGeometry,bgStarsMaterial);
    scene.add(bgStars);
    const waveShaderMaterial=new THREE.ShaderMaterial({uniforms:{uTime:{value:0.0}},vertexShader:`uniform float uTime;varying vec2 vUv;void main(){vUv=uv;vec3 pos=position;pos.y+=sin(uTime*0.8+position.x*0.002)*20.0;gl_Position=projectionMatrix*modelViewMatrix*vec4(pos,1.0);}`,fragmentShader:`uniform float uTime;varying vec2 vUv;void main(){float gradientShift=sin(uTime*0.5+vUv.x*3.1415)*0.5+0.5;vec3 color1=vec3(1.0,0.254,0.424);vec3 color2=vec3(0.0,0.447,1.0);vec3 gradient=mix(color1,color2,gradientShift);float alpha=smoothstep(0.48,0.5,1.0-abs(vUv.y-0.5));gl_FragColor=vec4(gradient,alpha*0.18);}`,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false});
    const ribbons=[];
    for(let i=0; i < 12; i++){ 
      const geo=new THREE.PlaneGeometry(40000,3,2000,1);
      const mesh=new THREE.Mesh(geo,waveShaderMaterial.clone());
      mesh.position.y=-100+i*25;
      mesh.position.z=-500+Math.random()*800;
      mesh.material.uniforms.uTime={value:Math.random()*100};
      scene.add(mesh);
      ribbons.push(mesh);
    }
    const starCount=2000;
    const starGeo=new THREE.BufferGeometry();
    const starPos=new Float32Array(starCount*3);
    for(let i=0; i < starCount; i++){starPos[i*3]=(Math.random()-0.5)*8000;starPos[i*3+1]=(Math.random()-0.5)*2000;starPos[i*3+2]=(Math.random()-0.5)*4000}
    starGeo.setAttribute('position',new THREE.BufferAttribute(starPos,3));
    const starMat=new THREE.PointsMaterial({color:0xffffff,size:1.0,transparent:true,opacity:0.5,blending:THREE.AdditiveBlending});
    const stars=new THREE.Points(starGeo,starMat);
    scene.add(stars);
    const clock=new THREE.Clock();
    function animate(){const t=clock.getElapsedTime();ribbons.forEach((r,i)=>{r.material.uniforms.uTime.value=t+i*0.3});bgStars.rotation.y+=0.00002;stars.rotation.y+=0.00004;renderer.render(scene,camera);requestAnimationFrame(animate)}
    animate();
    window.addEventListener('resize',()=>{renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix()});

    /* ---------- Success/Feedback Message Logic ---------- */
    const feedbackMessage = document.getElementById('feedback-message');
    function showFeedback(message) {
        feedbackMessage.textContent = message;
        feedbackMessage.classList.add('show');
        setTimeout(() => {
            feedbackMessage.classList.remove('show');
        }, 3000);
    }

    /* ---------- App state and feed rendering ---------- */
    const feed=document.getElementById('feed');
    const state={
      posts:[],
      currentUser:{id:'user123',name:'Student',initials:'SS'}
    };

    function escapeHtml(s){return String(s).replace(/[&"'<>]/g,c=>({"&":"&amp;","\"":"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"}[c]))}
    
    // Helper function to format seconds into MM:SS
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        const paddedSeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
        return `${minutes}:${paddedSeconds}`;
    }

    function createPostEl(post){
      const el=document.createElement('article');el.className='post';
      el.dataset.id = post.id;
      
      const authorName = post.authorId === state.currentUser.id ? 'You' : escapeHtml(post.author);
      const isLiked = post.likedBy.includes(state.currentUser.id);
      const isLoved = post.lovedBy.includes(state.currentUser.id);

      let mediaContent = '';

      if (post.type === 'video') {
        mediaContent = `
            <div class="video-container">
                <video src="${post.url}" preload="metadata"></video>
                <div class="custom-controls">
                    <div class="timeline-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <div class="controls-bar">
                        <button class="control-btn play-pause-btn">‚ñ∂</button>
                        <div class="time-display current-time">0:00</div>
                        <div class="time-display separator">/</div>
                        <div class="time-display duration">0:00</div>
                        <button class="control-btn mute-btn">üîä</button>
                        <button class="control-btn full-screen-btn">‚õ∂</button>
                    </div>
                </div>
            </div>
        `;
      } else {
        mediaContent = `<img src="${post.url}">`;
      }


      el.innerHTML=`
        <div class="meta"><div class="avatar">${post.authorInitials}</div><div><div class="name">${authorName}</div><div class="time">${new Date(post.time).toLocaleString()}</div></div></div>
        <div class="text-wrapping" style="margin-top:8px">${escapeHtml(post.caption)}</div>
        <div class="media" data-id="${post.id}">
            ${mediaContent}
            <div class="thumb-overlay">üëç</div>
            <div class="heart-overlay">‚ù§Ô∏è</div>
        </div>
        <div class="actions">
          <div class="btn likeBtn ${isLiked ? 'toggled' : ''}">üëç <span class="count">${post.likes||0}</span></div>
          <div class="btn loveBtn ${isLoved ? 'toggled' : ''}">‚ù§Ô∏è <span class="count">${post.loves||0}</span></div>
          <div class="btn commentToggle">üí¨ <span class="count">${(post.comments||[]).length}</span></div>
          <div class="btn shareBtn">üîó Share</div>
          <div class="share-menu" aria-hidden="true">
            <button class="btn share-web">üîó Share via...</button>
            <button class="btn share-copy">üìã Copy Link</button>
            <button class="btn share-email">‚úâÔ∏è Email</button>
            <button class="btn share-whatsapp">üí¨ WhatsApp</button>
            <button class="btn share-twitter">üê¶ Twitter</button>
          </div>
        </div>
      `;

      // --- Get buttons ---
      const likeBtn=el.querySelector('.likeBtn');
      const loveBtn=el.querySelector('.loveBtn');
      const commentToggle=el.querySelector('.commentToggle');
      const shareBtn=el.querySelector('.shareBtn');
      const shareMenu=el.querySelector('.share-menu');
      const media=el.querySelector('.media');
      const thumbOverlay=media.querySelector('.thumb-overlay');
      const heartOverlay=media.querySelector('.heart-overlay');

      // --- Video Control Setup (New) ---
      if (post.type === 'video') {
        const video = el.querySelector('video');
        const playPauseBtn = el.querySelector('.play-pause-btn');
        const muteBtn = el.querySelector('.mute-btn');
        const fullScreenBtn = el.querySelector('.full-screen-btn');
        const timeline = el.querySelector('.timeline-bar');
        const progressFill = el.querySelector('.progress-fill');
        const currentTimeEl = el.querySelector('.current-time');
        const durationEl = el.querySelector('.duration');
        
        // 1. Play/Pause
        playPauseBtn.addEventListener('click', () => {
            if (video.paused || video.ended) {
                video.play();
                playPauseBtn.textContent = '‚è∏';
            } else {
                video.pause();
                playPauseBtn.textContent = '‚ñ∂';
            }
        });

        // 2. Time Update and Progress Bar
        video.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(video.duration);
        });

        video.addEventListener('timeupdate', () => {
            if (!isNaN(video.duration)) {
                const percent = (video.currentTime / video.duration) * 100;
                progressFill.style.width = `${percent}%`;
                currentTimeEl.textContent = formatTime(video.currentTime);
            }
        });
        
        video.addEventListener('ended', () => {
            playPauseBtn.textContent = '‚ñ∂';
        });

        // 3. Seeking (Timeline Click)
        timeline.addEventListener('click', (e) => {
            const rect = timeline.getBoundingClientRect();
            const pos = e.clientX - rect.left;
            const newTime = (pos / rect.width) * video.duration;
            video.currentTime = newTime;
        });

        // 4. Mute/Unmute
        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            muteBtn.textContent = video.muted ? 'üîá' : 'üîä';
        });
        
        // 5. Full Screen
        fullScreenBtn.addEventListener('click', () => {
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) { /* Safari */
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) { /* IE11 */
                video.msRequestFullscreen();
            }
        });
      }
      function toggleLike(showAnimation = false){
        const userId = state.currentUser.id;
        const countSpan = likeBtn.querySelector('.count');
        if (post.likedBy.includes(userId)) {
          post.likes = (post.likes || 1) - 1;
          post.likedBy = post.likedBy.filter(id => id !== userId);
          likeBtn.classList.remove('toggled');
        } else {
          post.likes = (post.likes || 0) + 1;
          post.likedBy.push(userId);
          likeBtn.classList.add('toggled');
          if (showAnimation) {
            thumbOverlay.classList.add('show');
            showFeedback("Liked Post! üëç");
            setTimeout(()=>thumbOverlay.classList.remove('show'), 700);
          }
        }
        countSpan.textContent = post.likes;
      }

      function toggleLove(showAnimation = false) {
        const userId = state.currentUser.id;
        const countSpan = loveBtn.querySelector('.count');
        if (post.lovedBy.includes(userId)) {
          post.loves = (post.loves || 1) - 1;
          post.lovedBy = post.lovedBy.filter(id => id !== userId);
          loveBtn.classList.remove('toggled');
        } else {
          post.loves = (post.loves || 0) + 1;
          post.lovedBy.push(userId);
          loveBtn.classList.add('toggled');
          if (showAnimation) {
            heartOverlay.classList.add('show');
            showFeedback("Loved Post! ‚ù§Ô∏è");
            setTimeout(()=>heartOverlay.classList.remove('show'), 700);
          }
        }
        countSpan.textContent = post.loves;
      }

      likeBtn.addEventListener('click', () => toggleLike(true));
      loveBtn.addEventListener('click', () => toggleLove(true));

      // --- Comment Modal ---
      commentToggle.addEventListener('click', (e) => {
        e.stopPropagation(); // Stop click from bubbling to document
        openCommentModal(post, () => {
          commentToggle.querySelector('.count').textContent = (post.comments||[]).length;
        });
      });

      // --- Double click heart effect on media ---
      let lastClick=0;
      media.addEventListener('dblclick', () => {
        if (!post.lovedBy.includes(state.currentUser.id)) {
          toggleLove(true);
        }
      });
      media.addEventListener('touchstart',(ev)=>{const now=Date.now();if(now-lastClick<300){ev.preventDefault(); media.dispatchEvent(new Event('dblclick'))}lastClick=now});

      // --- Share Pop-up ---
      shareBtn.addEventListener('click',(e) => {
        e.stopPropagation();
        // Close other menus before opening this one
        document.querySelectorAll('.share-menu.show').forEach(m => m.classList.remove('show'));
        shareMenu.classList.toggle('show');
      });
      
      // Share actions
      el.querySelector('.share-web').addEventListener('click',async (e)=>{
        e.stopPropagation();
        if(navigator.share){
          try{await navigator.share({title:post.author, text:post.caption, url:post.url || window.location.href})}catch(err){}
        }else{alert('Web Share not supported. Try copying the link.')}
        shareMenu.classList.remove('show');
      });
      
      el.querySelector('.share-copy').addEventListener('click', (e) => {
        e.stopPropagation();
        navigator.clipboard.writeText(post.url || window.location.href).then(() => {
          e.target.textContent = '‚úÖ Copied!';
          setTimeout(() => { e.target.textContent = 'üìã Copy Link'; }, 2000);
        });
      });
      
      el.querySelector('.share-email').addEventListener('click', (e) => {
        e.stopPropagation();
        const subject = `Check out this post from ${post.author}`;
        const body = `${post.caption}\n\n${post.url || window.location.href}`;
        location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        shareMenu.classList.remove('show');
      });

      el.querySelector('.share-whatsapp').addEventListener('click',(e)=>{e.stopPropagation(); const url=`https://wa.me/?text=${encodeURIComponent(post.caption+' '+ (post.url || window.location.href))}`;window.open(url,'_blank'); shareMenu.classList.remove('show');});
      el.querySelector('.share-twitter').addEventListener('click',(e)=>{e.stopPropagation(); const url=`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.caption)}&url=${encodeURIComponent(post.url || window.location.href)}`;window.open(url,'_blank'); shareMenu.classList.remove('show');});

      return el;
    }
    
    // Global click to close share menus
    document.addEventListener('click', () => {
      document.querySelectorAll('.share-menu.show').forEach(menu => menu.classList.remove('show'));
    });

    function renderFeed(postsToRender = state.posts){
      const currentPostEls = Array.from(feed.children);
      const newPostsEl = document.createDocumentFragment();
      let hasNewPost = false;
      
      postsToRender.forEach(p=>{
        let el = document.querySelector(`.post[data-id="${p.id}"]`);
        if (!el) {
            el = createPostEl(p);
            el.classList.add('new'); // Add class for animation
            newPostsEl.prepend(el);
            hasNewPost = true;
        } else {
            // Re-render existing posts to update counts, but don't re-animate
            newPostsEl.appendChild(el);
        }
      });
      
      // If no new posts, just update
      if (!hasNewPost && feed.children.length === postsToRender.length) return;

      // Apply opacity transition to feed for smooth refresh/upload
      feed.style.opacity = 0;
      setTimeout(() => {
        feed.innerHTML = ''; // Clear old content
        // Append all the new and existing elements back to the feed
        postsToRender.forEach(p => {
            const el = createPostEl(p);
            feed.appendChild(el);
        });
        feed.style.opacity = 1; // Fade back in
      }, hasNewPost ? 400 : 0); // Short delay if there's a new post to show the fade

    }
    renderFeed();

    /* ---------- Modal Logic ---------- */
    const commentModal = document.getElementById('commentModal');
    const commentModalList = document.getElementById('commentModalList');
    const commentModalTextarea = document.getElementById('commentModalTextarea');
    const commentModalPostBtn = document.getElementById('commentModalPostBtn');
    let currentPostUpdateCallback = null;

    function renderCommentsForModal(post) {
      // Temporarily store the existing comments to re-add later
      const existingComments = Array.from(commentModalList.querySelectorAll('.comment'));
      commentModalList.innerHTML = '';
      
      (post.comments || []).forEach(c => {
        const isMine = c.by === state.currentUser.name;
        const d = document.createElement('div');
        d.className = `comment ${isMine ? 'mine' : ''}`;
        
        const commentAuthor = isMine ? 'You' : escapeHtml(c.by);
        const authorInitials = isMine ? state.currentUser.initials : (c.byInitials || c.by[0]);
        
        d.innerHTML = `
          <div class="cavatar">${authorInitials}</div>
          <div class="ctext">
            <strong>${commentAuthor}</strong>
            <div class="text-wrapping" style="font-size:13px;color:rgba(233,238,248,0.8)">${escapeHtml(c.text)}</div>
          </div>`;
        commentModalList.appendChild(d);
      });
      // Scroll to bottom
      commentModalList.scrollTop = commentModalList.scrollHeight;
    }

    function openCommentModal(post, updateCallback) {
      currentPostUpdateCallback = updateCallback;
      commentModalPostBtn.dataset.postId = post.id;
      renderCommentsForModal(post);
      commentModalTextarea.value = '';
      commentModal.classList.add('show');
      commentModalTextarea.focus();
    }

    commentModalPostBtn.addEventListener('click', () => {
      const text = commentModalTextarea.value.trim();
      if (!text) return;
      const postId = commentModalPostBtn.dataset.postId;
      const post = state.posts.find(p => p.id === postId);
      if (!post) return;

      post.comments = post.comments || [];
      post.comments.push({
        by: state.currentUser.name,
        byInitials: state.currentUser.initials,
        text
      });
      
      commentModalTextarea.value = '';
      renderCommentsForModal(post);
      if (currentPostUpdateCallback) {
        currentPostUpdateCallback();
      }
      showFeedback("Commented successfully! üí¨");
    });

    // Close modal when clicking overlay
    commentModal.addEventListener('click', (e) => {
      if (e.target === commentModal) {
        commentModal.classList.remove('show');
      }
    });

    /* ---------- UI interactions for panels ---------- */
    document.getElementById('closeReminder').addEventListener('click',(e)=>{ e.stopPropagation(); document.getElementById('reminderCard').classList.remove('active')});
    document.getElementById('closeNotifs').addEventListener('click',(e)=>{ e.stopPropagation(); document.getElementById('notifsCard').classList.remove('active')});
    document.getElementById('closeSchedule').addEventListener('click',(e)=>{ e.stopPropagation(); document.getElementById('scheduleCard').classList.remove('active')});
    document.getElementById('closeDevices').addEventListener('click',(e)=>{ e.stopPropagation(); document.getElementById('devicesCard').classList.remove('active')});
    document.getElementById('closeTests').addEventListener('click',(e)=>{ e.stopPropagation(); document.getElementById('testsCard').classList.remove('active')});

    ['reminderCard','scheduleCard','addEpicCard','notifsCard','devicesCard','testsCard'].forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener('click',(e)=>{
        if (el.contains(e.target) && !el.classList.contains('active')) {
          document.querySelectorAll('.mini-card.active').forEach(ac => ac.classList.remove('active'));
          el.classList.add('active');
        }
      });
    });

    // Global click listener to close side panels
    document.addEventListener('click', (e) => {
      const activeCard = document.querySelector('.mini-card.active');
      if (activeCard && !e.target.closest('.mini-card.active')) {
        activeCard.classList.remove('active');
      }
    });

    /* ---------- Add content / upload handling (FIXED V2) ---------- */
    const epicFileInput=document.getElementById('epicFileInput');
    const epicPreview=document.getElementById('epicPreview');
    const epicCaption=document.getElementById('epicCaption');
    let pending=null;
    
    // File selection handling: triggered when a file is chosen in the dialog
    epicFileInput.addEventListener('change',(e)=>{
        const file=e.target.files[0];
        
        if(!file) {
            document.getElementById('fileChooseLabel').textContent = 'Select file';
            return;
        }
        
        const url=URL.createObjectURL(file);
        const type=file.type.startsWith('video')?'video':'image';
        
        pending={file,url,type};
        document.getElementById('fileChooseLabel').textContent = file.name; // Update label
        
        // Use the same media structure for video preview as for the final post
        epicPreview.innerHTML=`<div class="${type === 'video' ? 'video-container' : ''}" style="width:100%; height:100%;">
            ${type==='image'
                ? `<img src="${url}" style="max-width:100%;max-height:100%; object-fit: contain;">`
                : `<video src="${url}" controls style="max-width:100%;max-height:100%; object-fit: contain;"></video>`
            }
        </div>`;
    });
    
    document.getElementById('confirmUpload').addEventListener('click',()=>{
        if(!pending)return;

        // 1. Temporarily hide feed for smooth animation
        feed.style.opacity = 0;

        setTimeout(() => {
            // 2. Add new post
            state.posts.unshift({
                id:Date.now().toString(),
                author:state.currentUser.name,
                authorId:state.currentUser.id,
                authorInitials:state.currentUser.initials,
                time:Date.now(),
                url:pending.url,
                type:pending.type,
                caption:epicCaption.value||'My post',
                likes:0,loves:0,comments:[], likedBy: [], lovedBy: []
            });
            
            // 3. Re-render and fade back in
            renderFeed(); 
            feed.style.opacity = 1;
            showFeedback("Posted successfully! üéâ");

            // 4. Reset UI
            pending=null;
            epicFileInput.value='';
            epicPreview.innerHTML='No preview';
            epicCaption.value='';
            document.getElementById('fileChooseLabel').textContent = 'Select file'; // Reset label
            document.getElementById('addEpicCard').classList.remove('active');
        }, 400); // Wait for the fade-out transition
    });

    document.getElementById('cancelUpload').addEventListener('click',()=>{
        pending=null;
        epicFileInput.value='';
        epicPreview.innerHTML='No preview';
        epicCaption.value='';
        document.getElementById('fileChooseLabel').textContent = 'Select file'; // Reset label
        document.getElementById('addEpicCard').classList.remove('active')
    });
    
    /* ---------- Search and Refresh ---------- */
    const searchBar = document.getElementById('searchBar');
    searchBar.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      if (!searchTerm) {
        renderFeed(state.posts);
        return;
      }
      const filteredPosts = state.posts.filter(p => 
        p.caption.toLowerCase().includes(searchTerm) || 
        p.author.toLowerCase().includes(searchTerm)
      );
      renderFeed(filteredPosts);
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      searchBar.value = '';
      renderFeed(state.posts);
    });

    /* ---------- sample lists ---------- */
    document.getElementById('remindersList').innerHTML='<li style="padding:8px">Math homework due 10/30</li>';
    document.getElementById('notifList').innerHTML='<li style="padding:8px">New message from Ms. Rao</li>';
    document.getElementById('schedulesList').innerHTML='<li style="padding:8px">Project presentation - 11/05</li>';
    document.getElementById('devicesList').innerHTML='<li style="padding:8px">Chromebook A12</li>';
    document.getElementById('testsList').innerHTML='<li style="padding:8px">Unit test: Chapter 4 - 11/02</li>';

    /* ---------- Navbar underline logic & Redirection ---------- */
    const navWrap=document.getElementById('navWrap');
    const underline=document.getElementById('navUnderline');
    function updateUnderline(el){const rect=el.getBoundingClientRect();const wrapRect=navWrap.getBoundingClientRect();underline.style.width=(rect.width-20)+'px';underline.style.transform=`translateX(${rect.left - wrapRect.left + 10}px)`}
    
    // Set initial position
    const firstActive=navWrap.querySelector('.nav-item.active')||navWrap.querySelector('.nav-item');
    updateUnderline(firstActive);

    // Add listeners
    navWrap.querySelectorAll('.nav-item').forEach(it=>{
      // Move underline on hover
      it.addEventListener('mouseenter',()=>updateUnderline(it));
      
      // On click, set active and REDIRECT
      it.addEventListener('click',()=>{
        // Check if the clicked item is already active
        const isActive = it.classList.contains('active');
        
        // Update active class and underline
        navWrap.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        it.classList.add('active');
        updateUnderline(it);

        const pageName = it.dataset.name;
        
        // Redirect if the element is not 'home' OR if it was already selected
        if (pageName !== 'home' || isActive) {
             location.href = pageName + '.html'; // REDIRECTION IMPLEMENTED
        }
      });
    });

    // On mouse leave, snap back to the active item
    navWrap.addEventListener('mouseleave', () => {
      const active = navWrap.querySelector('.nav-item.active');
      if (active) updateUnderline(active);
    });

    // Update on resize
    window.addEventListener('resize',()=>{const active=navWrap.querySelector('.nav-item.active')||navWrap.querySelector('.nav-item');if(active) updateUnderline(active)});

    // prevent feed horizontal scroll
    feed.addEventListener('wheel', (e)=>{ if(Math.abs(e.deltaX)>0 && Math.abs(e.deltaX)>Math.abs(e.deltaY)){ e.preventDefault(); } }, {passive:false});

    // expose a small api on window for debugging
    window._epicState=state;

   </script>

<script type="module" src="home.js">
  
</script>
</body>
</html>
